#!/bin/sh
# mesh-init - Initialize WireGuard mesh network
# Part of WireGuard Mesh Manager

set -e

SCRIPT_DIR="$(dirname "$0")"
LIB_DIR="${SCRIPT_DIR}/../lib"
CONF_DIR="/etc/wg-mesh"

# Source environment file if present
ENV_FILE="${SCRIPT_DIR}/../../.env"
[ -f "$ENV_FILE" ] && . "$ENV_FILE"
[ -f "/etc/wg-mesh/.env" ] && . "/etc/wg-mesh/.env"

# Source libraries
if [ -f "${LIB_DIR}/logging.sh" ]; then
    . "${LIB_DIR}/logging.sh"
else
    # Fallback if installed system-wide
    . /usr/share/wg-mesh/lib/logging.sh 2>/dev/null || true
fi

usage() {
    cat <<EOF
Usage: mesh-init [OPTIONS]

Initialize a new WireGuard mesh network.

Options:
    -n, --name NAME       Mesh network name (default: wg-mesh)
    -s, --subnet CIDR     Mesh subnet (default: 10.99.0.0/24)
    -p, --port PORT       WireGuard port (default: 51820)
    -f, --force           Overwrite existing configuration
    -h, --help            Show this help message

Examples:
    mesh-init
    mesh-init --name office-mesh --subnet 10.100.0.0/24
    mesh-init --force
EOF
}

# Default values (can be overridden via .env)
MESH_NAME="wg-mesh"
MESH_SUBNET="${WG_MESH_DEFAULT_SUBNET:-10.99.0.0/24}"
MESH_PORT="${WG_MESH_DEFAULT_PORT:-51820}"
FORCE=0

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        -n|--name)
            MESH_NAME="$2"
            shift 2
            ;;
        -s|--subnet)
            MESH_SUBNET="$2"
            shift 2
            ;;
        -p|--port)
            MESH_PORT="$2"
            shift 2
            ;;
        -f|--force)
            FORCE=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Check for root
if [ "$(id -u)" != "0" ]; then
    echo "ERROR: This command must be run as root"
    exit 1
fi

# Check if already initialized
if [ -f "${CONF_DIR}/mesh.conf" ] && [ "$FORCE" != "1" ]; then
    echo "ERROR: Mesh already initialized at ${CONF_DIR}"
    echo "Use --force to reinitialize"
    exit 1
fi

echo "Initializing WireGuard mesh network..."
echo ""
echo "  Name:   ${MESH_NAME}"
echo "  Subnet: ${MESH_SUBNET}"
echo "  Port:   ${MESH_PORT}"
echo ""

# Create directories
mkdir -p "${CONF_DIR}"
mkdir -p "${CONF_DIR}/backups"
mkdir -p "${CONF_DIR}/keys"
chmod 700 "${CONF_DIR}/keys"

# Create configuration
cat > "${CONF_DIR}/mesh.conf" <<EOF
# WireGuard Mesh Manager Configuration
# Generated by mesh-init on $(date)

# Mesh network settings
MESH_NAME="${MESH_NAME}"
MESH_INTERFACE="${MESH_NAME}"
MESH_SUBNET="${MESH_SUBNET}"
MESH_PORT="${MESH_PORT}"

# Logging
LOG_LEVEL="info"
LOG_FILE="/var/log/wg-mesh.log"

# Auto-apply settings
AUTO_APPLY="false"
AUTO_BACKUP="true"
EOF

# Create empty peers database
touch "${CONF_DIR}/peers.db"

# Generate WireGuard keys if not present
if [ ! -f "${CONF_DIR}/keys/privatekey" ]; then
    echo "Generating WireGuard keys..."
    wg genkey | tee "${CONF_DIR}/keys/privatekey" | wg pubkey > "${CONF_DIR}/keys/publickey"
    chmod 600 "${CONF_DIR}/keys/privatekey"
fi

echo ""
echo "Mesh network initialized successfully!"
echo ""
echo "Your public key:"
cat "${CONF_DIR}/keys/publickey"
echo ""
echo "Next steps:"
echo "  1. mesh-add <name> fixed <ip/mask> <endpoint> --public-key <key>"
echo "  2. mesh-generate"
echo "  3. mesh-apply-local"
