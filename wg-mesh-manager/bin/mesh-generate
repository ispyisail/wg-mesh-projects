#!/bin/sh
# mesh-generate - Generate WireGuard configuration files
# Part of WireGuard Mesh Manager

set -e

CONF_DIR="/etc/wg-mesh"
WG_DIR="/etc/wireguard"

usage() {
    cat <<EOF
Usage: mesh-generate [OPTIONS]

Generate WireGuard configuration files for all peers.

Options:
    --local-only      Only generate local configuration
    --peer NAME       Generate config for specific peer only
    --output DIR      Output directory (default: /etc/wireguard)
    --dry-run         Show what would be generated
    -h, --help        Show this help message

Examples:
    mesh-generate
    mesh-generate --local-only
    mesh-generate --peer laptop --output /tmp
EOF
}

LOCAL_ONLY=0
SPECIFIC_PEER=""
OUTPUT_DIR="$WG_DIR"
DRY_RUN=0

while [ $# -gt 0 ]; do
    case "$1" in
        --local-only)
            LOCAL_ONLY=1
            shift
            ;;
        --peer)
            SPECIFIC_PEER="$2"
            shift 2
            ;;
        --output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Check for root
if [ "$(id -u)" != "0" ] && [ "$DRY_RUN" != "1" ]; then
    echo "ERROR: This command must be run as root"
    exit 1
fi

# Check if initialized
if [ ! -f "${CONF_DIR}/mesh.conf" ]; then
    echo "ERROR: Mesh not initialized. Run 'mesh-init' first."
    exit 1
fi

# Load mesh config
. "${CONF_DIR}/mesh.conf"

# Get local private key
if [ ! -f "${CONF_DIR}/keys/privatekey" ]; then
    echo "ERROR: Local private key not found"
    exit 1
fi
LOCAL_PRIVKEY=$(cat "${CONF_DIR}/keys/privatekey")

echo "Generating WireGuard configurations..."
echo ""

# Create output directory
[ "$DRY_RUN" != "1" ] && mkdir -p "$OUTPUT_DIR"

# Generate configuration
generate_config() {
    local interface_name="$1"
    local listen_port="$2"
    local private_key="$3"

    cat <<EOF
# WireGuard Mesh Configuration
# Generated by mesh-generate on $(date)
# Interface: ${interface_name}

[Interface]
PrivateKey = ${private_key}
ListenPort = ${listen_port}

EOF

    # Add all peers
    while IFS='|' read -r name type ip endpoint pubkey allowed keepalive desc; do
        cat <<EOF
# Peer: ${name}
[Peer]
PublicKey = ${pubkey}
AllowedIPs = ${allowed}
EOF
        if [ "$endpoint" != "dynamic" ] && [ -n "$endpoint" ]; then
            echo "Endpoint = ${endpoint}"
        fi
        if [ -n "$keepalive" ] && [ "$keepalive" != "0" ]; then
            echo "PersistentKeepalive = ${keepalive}"
        fi
        echo ""
    done < "${CONF_DIR}/peers.db"
}

# Generate the configuration
CONFIG=$(generate_config "$MESH_INTERFACE" "$MESH_PORT" "$LOCAL_PRIVKEY")

if [ "$DRY_RUN" = "1" ]; then
    echo "Would generate: ${OUTPUT_DIR}/${MESH_INTERFACE}.conf"
    echo ""
    echo "--- Configuration Preview ---"
    echo "$CONFIG"
    echo "--- End Preview ---"
else
    echo "$CONFIG" > "${OUTPUT_DIR}/${MESH_INTERFACE}.conf"
    chmod 600 "${OUTPUT_DIR}/${MESH_INTERFACE}.conf"
    echo "Generated: ${OUTPUT_DIR}/${MESH_INTERFACE}.conf"
fi

echo ""
echo "Configuration generated successfully!"
echo ""
echo "Run 'mesh-apply-local' to apply the configuration"
