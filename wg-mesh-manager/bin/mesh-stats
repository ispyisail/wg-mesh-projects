#!/bin/sh
# mesh-stats - Show mesh network statistics
# Part of WireGuard Mesh Manager

CONF_DIR="/etc/wg-mesh"

usage() {
    cat <<EOF
Usage: mesh-stats [OPTIONS]

Show mesh network statistics.

Options:
    -w, --watch     Continuously update
    --json          Output as JSON
    -h, --help      Show this help message

Examples:
    mesh-stats
    mesh-stats --watch
EOF
}

WATCH=0
JSON=0

while [ $# -gt 0 ]; do
    case "$1" in
        -w|--watch)
            WATCH=1
            shift
            ;;
        --json)
            JSON=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Load mesh config
if [ ! -f "${CONF_DIR}/mesh.conf" ]; then
    echo "ERROR: Mesh not initialized"
    exit 1
fi
. "${CONF_DIR}/mesh.conf"

format_bytes() {
    bytes=$1
    # Use awk instead of bc (POSIX compliant, works on OpenWrt)
    if [ "$bytes" -ge 1073741824 ]; then
        awk "BEGIN {printf \"%.2f GiB\", $bytes/1073741824}"
    elif [ "$bytes" -ge 1048576 ]; then
        awk "BEGIN {printf \"%.2f MiB\", $bytes/1048576}"
    elif [ "$bytes" -ge 1024 ]; then
        awk "BEGIN {printf \"%.2f KiB\", $bytes/1024}"
    else
        printf "%d B" "$bytes"
    fi
}

show_stats() {
    if ! ip link show "$MESH_INTERFACE" >/dev/null 2>&1; then
        if [ "$JSON" = "1" ]; then
            echo '{"error":"interface not running"}'
        else
            echo "Interface ${MESH_INTERFACE} is not running"
        fi
        return 1
    fi

    # Get stats from WireGuard
    WG_OUTPUT=$(wg show "$MESH_INTERFACE" 2>/dev/null)

    if [ "$JSON" = "1" ]; then
        echo "{"
        echo "  \"interface\": \"$MESH_INTERFACE\","
        echo "  \"peers\": ["

        FIRST=1
        echo "$WG_OUTPUT" | grep -A4 "^peer:" | while read -r line; do
            case "$line" in
                peer:*)
                    [ "$FIRST" = "1" ] && FIRST=0 || echo ","
                    PUBKEY=$(echo "$line" | cut -d' ' -f2)
                    printf "    {\"public_key\":\"%s\"" "$PUBKEY"
                    ;;
                *transfer:*)
                    RX=$(echo "$line" | grep -oE '[0-9.]+ [KMGT]?i?B' | head -1)
                    TX=$(echo "$line" | grep -oE '[0-9.]+ [KMGT]?i?B' | tail -1)
                    printf ",\"rx\":\"%s\",\"tx\":\"%s\"}" "$RX" "$TX"
                    ;;
            esac
        done
        echo ""
        echo "  ]"
        echo "}"
        return
    fi

    echo "========================================"
    echo "Mesh Network Statistics"
    echo "========================================"
    echo ""
    echo "Interface: ${MESH_INTERFACE}"
    echo ""

    # Interface stats
    if [ -f "/sys/class/net/${MESH_INTERFACE}/statistics/rx_bytes" ]; then
        RX_BYTES=$(cat "/sys/class/net/${MESH_INTERFACE}/statistics/rx_bytes")
        TX_BYTES=$(cat "/sys/class/net/${MESH_INTERFACE}/statistics/tx_bytes")
        RX_PACKETS=$(cat "/sys/class/net/${MESH_INTERFACE}/statistics/rx_packets")
        TX_PACKETS=$(cat "/sys/class/net/${MESH_INTERFACE}/statistics/tx_packets")

        echo "Interface Totals:"
        echo "  RX: $(format_bytes "$RX_BYTES") ($RX_PACKETS packets)"
        echo "  TX: $(format_bytes "$TX_BYTES") ($TX_PACKETS packets)"
        echo ""
    fi

    # Per-peer stats
    echo "Per-Peer Statistics:"
    echo "--------------------"
    printf "%-20s %-15s %-15s %s\n" "PEER" "RX" "TX" "LAST HANDSHAKE"
    printf "%-20s %-15s %-15s %s\n" "----" "--" "--" "--------------"

    echo "$WG_OUTPUT" | awk '
        /^peer:/ { pubkey = substr($2, 1, 16) }
        /latest handshake:/ {
            handshake = $3 " " $4 " " $5
        }
        /transfer:/ {
            rx = $2 " " $3
            tx = $5 " " $6
            printf "%-20s %-15s %-15s %s\n", pubkey "...", rx, tx, handshake
            handshake = "never"
        }
    '
}

if [ "$WATCH" = "1" ]; then
    while true; do
        clear
        show_stats
        echo ""
        echo "(Press Ctrl+C to exit, refreshing every 2s)"
        sleep 2
    done
else
    show_stats
fi
