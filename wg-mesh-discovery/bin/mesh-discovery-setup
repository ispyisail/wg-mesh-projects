#!/bin/sh
# mesh-discovery-setup - Initialize device discovery
# Part of WireGuard Mesh Discovery

set -e

CONF_DIR="/etc/wg-mesh"
DISCOVERY_CONF="${CONF_DIR}/discovery.conf"

usage() {
    cat <<EOF
Usage: mesh-discovery-setup [OPTIONS]

Initialize device discovery module.

Options:
    --check         Check dependencies only
    --reconfigure   Reconfigure existing setup
    -h, --help      Show this help message
EOF
}

CHECK_ONLY=0
RECONFIGURE=0

while [ $# -gt 0 ]; do
    case "$1" in
        --check)
            CHECK_ONLY=1
            shift
            ;;
        --reconfigure)
            RECONFIGURE=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "WireGuard Mesh Discovery Setup"
echo "=============================="
echo ""

# Check mesh manager
echo "Checking dependencies..."
if [ ! -f "${CONF_DIR}/mesh.conf" ]; then
    echo "[FAIL] WireGuard Mesh Manager not installed"
    echo "       Install wg-mesh-manager first"
    exit 1
fi
echo "[OK] WireGuard Mesh Manager found"

# Check optional dependencies
NMAP_OK=0
AVAHI_OK=0
ARPSCAN_OK=0

if command -v nmap >/dev/null 2>&1; then
    echo "[OK] nmap found"
    NMAP_OK=1
else
    echo "[OPTIONAL] nmap not found (install for enhanced scanning)"
fi

if command -v avahi-browse >/dev/null 2>&1; then
    echo "[OK] avahi-daemon found"
    AVAHI_OK=1
else
    echo "[OPTIONAL] avahi-daemon not found (install for mDNS support)"
fi

if command -v arp-scan >/dev/null 2>&1; then
    echo "[OK] arp-scan found"
    ARPSCAN_OK=1
else
    echo "[OPTIONAL] arp-scan not found (using standard ARP)"
fi

if [ "$CHECK_ONLY" = "1" ]; then
    exit 0
fi

# Check if already configured
if [ -f "$DISCOVERY_CONF" ] && [ "$RECONFIGURE" != "1" ]; then
    echo ""
    echo "Discovery already configured."
    echo "Use --reconfigure to reconfigure."
    exit 0
fi

echo ""
echo "Configuring discovery..."

# Create directories
mkdir -p "${CONF_DIR}/discovery"
mkdir -p "${CONF_DIR}/discovery/cache"

# Create/update config
if [ ! -f "$DISCOVERY_CONF" ] || [ "$RECONFIGURE" = "1" ]; then
    # Determine scan methods
    SCAN_METHODS="arp"
    [ "$NMAP_OK" = "1" ] && SCAN_METHODS="${SCAN_METHODS},nmap"
    [ "$AVAHI_OK" = "1" ] && SCAN_METHODS="${SCAN_METHODS},mdns"

    cat > "$DISCOVERY_CONF" <<EOF
# WireGuard Mesh Discovery Configuration
# Generated by mesh-discovery-setup on $(date)

SCAN_INTERVAL="300"
SCAN_METHODS="${SCAN_METHODS}"
SCAN_TIMEOUT="30"

DNS_INTEGRATION="true"
DNS_SUFFIX=".mesh"
DNS_UPDATE_ON_SCAN="true"

IDENTIFY_PRINTERS="true"
IDENTIFY_NAS="true"
IDENTIFY_CAMERAS="true"

MESH_SYNC="true"
DISCOVERY_LOG="/var/log/wg-mesh-discovery.log"
EOF
    echo "[OK] Configuration created"
fi

# Configure dnsmasq integration
if [ -f /etc/dnsmasq.conf ]; then
    if ! grep -q "wg-mesh-discovery" /etc/dnsmasq.conf; then
        echo "" >> /etc/dnsmasq.conf
        echo "# WireGuard Mesh Discovery DNS" >> /etc/dnsmasq.conf
        echo "addn-hosts=/tmp/wg-mesh-discovery-hosts" >> /etc/dnsmasq.conf
        echo "[OK] dnsmasq configured"
    fi
fi

# Create empty hosts file
touch /tmp/wg-mesh-discovery-hosts

echo ""
echo "Setup complete!"
echo ""
echo "Next steps:"
echo "  mesh-discovery-scan     # Scan for devices"
echo "  mesh-discovery-list     # View discovered devices"
echo "  mesh-discovery-enable   # Enable auto-scanning"
